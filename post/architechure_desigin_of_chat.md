+++
date = "2016-10-05"
title = "小书包在线聊天系统架构演进"
draft = false
description = ""
tags        = ["架构"]
categories = [ "技术"]
+++

介绍小书包聊天系统的架构历史及发展方向

<!--more-->

## 技术方案
开发在线聊天功能考虑的第一个问题是: 能不能用第三方的系统?

第三方的系统已经有成熟的商业解决方案, 自行开发成本很高. 但问题在于:

- 如果经过第三方系统, 数据安全方面能不能得到保证
- 如果要对聊天内容进行限制, 第三方系统是否能够做到

经过调研, 发现上面两个问题基本很难解决. 

那么能不能用开源的系统? 有许多具有很多应用案例的组合可以选择. 但是经过研究发现, 这些系统在部署和维护上也需要较大的投入, 再结合我们的技术选型和初期的产品需求, 发现自己开发一个反而成本较低, 而且后期也可以按照业务需求灵活改动. 

### 单例
初期的产品需求比较简单, 只要登录的人能够在群内互相发送消息即可, 不需要群的管理和消息的持久化

所以第一版的在线聊天经过几天的开发就可以使用了. 它的功能包括:

- 用户上线时, 访问服务, 服务根据用户属性, 将其分配到预设的群中
- 用户发送消息, 该消息会通过 websocket 转发给群内的其他成员
- 支持文字, 图片和语音

第一版在一台服务器上满足了十万人左右的聊天需求

### 多节点
用户量的增多对系统提出了更多的挑战, 主要有以下几个:

- 用户量增大, 单个服务器难以承载
- 登录过程较慢, 系统升级造成服务的中断

为了解决这些问题, 系统在架构上进行以下的改进:

1. 预先创建群
2. 分配服务器节点和聊天功能进行模块上的分离, 分别由不同的服务负责, 各个模块可以单独部署
3. 用户登录采用两段式, 即先获取分配服务器节点, 通过分配服务器获取登录节点, 最终在分配的登录服务器节点上登录

改造完成后, 用户量承载方面已经没有问题, 由于多节点的支持, 用户登录也较为快速, 基本解决问题

### 高可用
随着用户分布范围的扩大, 遇到的网络情况变得复杂起来; 同时对服务的可用性也提出了更高的要求. 这种情况下需要解决的问题有:

- 服务器分配节点的服务器失效
- 终端对外网络有限制, 无法连接到服务器
- 用户分配的节点服务器失效或者系统升级重启

为了解决上述问题, 系统进行了如下改进:

- 客户端路由和分配服务器多点
> 客户端进行第一段的登录请求时, 获取的将会是一组分配服务器地址, 客户端轮询服务器列表, 其中一个失效不会阻碍登录的进行

- 用户群在各个聊天节点的自动迁移, 解决了节点升级和失效的问题

### 未来计划

- 用户消息的持久化
- 用户群在节点间迁移, 消息自动同步
- 跳出聊天的范畴, 成为一个数据传输管道