+++
date = "2017-02-11"
title = "一个Mongo连接池库的介绍"
draft = false
description = ""
tags        = ["库", "Mongo"]
categories = [ "技术"]
+++

自己写了一个Mongo连接池, 已用在生产中, 算是重复制造轮子

<!--more-->
 
## 为什么用连接池

连接 Mongo 时, 如果连接太多, 会导致数据库因并发连接太多而崩溃; 如果 Mongo 采用了 Primary 和 Secondary 模式, 会导致各个实例的角色不断转换, 从而导致数据不停的在各个实例之间同步, 不仅造成了服务器的负担, 而且导致数据库出错的概率急剧增大, 甚至导致整个系统的运行出错.

为了解决这个问题, 就要限制各个应用连接 Mongo 的连接数量. 

## 支持特性

1. 限制了应用并发连接数量
2. 数据库断线自动重连

## 如何查看连接数量
linux :
```
sudo netstat -apn | grep 27107
```

macOS
```
sudo lsof -nP -iTCP  | grep mongo
```


## 连接池原理

### 数量限制

每次需要创建连接时, 首先申请一个连接, 如果已经超过了一定数量, 则请求被驳回, 也就是不能创建新连接, 从而达到了限制连接数量的目的

### 数据库断线重连

数据库需要重启时, 不需要要重新启动应用.

当操作数据库失败时, 启动之前创建的连接的刷新流程

## 使用方法

参照该库提供的[例子](https://github.com/ssor/mongopool/blob/master/example/main.go)
